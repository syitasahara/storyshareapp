import{s as r}from"./index-B5PYlZDb.js";const a="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";class c{constructor(){this.isSubscribed=!1,this.subscription=null,this.registration=null,this.isInitialized=!1}async init(){if(this.isInitialized)return!0;if(!this.supportsPush())return console.warn("Push notifications not supported"),!1;try{return navigator.serviceWorker.controller||(console.log("Waiting for service worker registration..."),await new Promise(i=>{navigator.serviceWorker.controller?i():navigator.serviceWorker.addEventListener("controllerchange",i)})),this.registration=await navigator.serviceWorker.ready,console.log("Service worker ready:",this.registration),await this.checkSubscription(),this.setupEventListeners(),this.isInitialized=!0,console.log("Push notification manager initialized successfully"),!0}catch(i){return console.error("Push notification init error:",i),!1}}supportsPush(){const i="serviceWorker"in navigator&&"PushManager"in window;return console.log("Push support check:",i),i}async checkSubscription(){try{return this.registration||(this.registration=await navigator.serviceWorker.ready),this.subscription=await this.registration.pushManager.getSubscription(),this.isSubscribed=!!this.subscription,console.log("Subscription check - subscribed:",this.isSubscribed),console.log("Current subscription:",this.subscription),this.isSubscribed}catch(i){return console.error("Error checking subscription:",i),this.isSubscribed=!1,!1}}async requestPermission(){if(!("Notification"in window))throw new Error("Browser tidak mendukung notifikasi");if(console.log("Current notification permission:",Notification.permission),Notification.permission==="granted")return!0;if(Notification.permission==="denied")throw new Error("Izin notifikasi telah ditolak. Silakan aktifkan di pengaturan browser.");const i=await Notification.requestPermission();return console.log("Notification permission result:",i),i==="granted"}async subscribeToPush(){if(console.log("Starting push subscription..."),this.registration||(this.registration=await navigator.serviceWorker.ready),!await this.requestPermission())throw new Error("Izin notifikasi ditolak");try{const t=this.urlBase64ToUint8Array(a);return console.log("Application server key converted"),this.subscription=await this.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t}),console.log("Push subscription successful:",this.subscription),await this.sendSubscriptionToServer(this.subscription),this.isSubscribed=!0,this.onSubscriptionChange(!0),console.log("Push notification subscribed successfully"),this.subscription}catch(t){throw console.error("Subscribe error:",t),t.name==="NotAllowedError"?new Error("Izin notifikasi ditolak oleh browser"):t.name==="AbortError"?new Error("Proses subscribe dibatalkan"):new Error(`Gagal subscribe: ${t.message}`)}}async sendSubscriptionToServer(i){try{console.log("Sending subscription to server...");const t={endpoint:i.endpoint,keys:{p256dh:i.toJSON().keys.p256dh,auth:i.toJSON().keys.auth}};if(console.log("Subscription data to send:",t),!localStorage.getItem("token")){console.warn("No user token found, skipping server registration");return}const s=await r.subscribePush(t);console.log("Server subscription response:",s),localStorage.setItem("pushSubscription",JSON.stringify(i))}catch(t){console.error("Error sending subscription to server:",t)}}async unsubscribeFromPush(){if(console.log("Starting push unsubscribe..."),!this.subscription)return console.log("No subscription to unsubscribe from"),!0;try{const i=await this.subscription.unsubscribe();return console.log("Unsubscribe result:",i),i&&(await this.removeSubscriptionFromServer(),localStorage.removeItem("pushSubscription"),this.subscription=null,this.isSubscribed=!1,this.onSubscriptionChange(!1),console.log("Push notification unsubscribed successfully")),i}catch(i){throw console.error("Unsubscribe error:",i),i}}async removeSubscriptionFromServer(){try{if(!localStorage.getItem("token")||!this.subscription)return;await r.unsubscribePush(this.subscription.endpoint),console.log("Subscription removed from server")}catch(i){console.error("Error removing subscription from server:",i)}}async toggleSubscription(){return console.log("Toggling push subscription..."),this.isSubscribed?await this.unsubscribeFromPush():await this.subscribeToPush(),this.isSubscribed}async getSubscriptionState(){return await this.checkSubscription(),{isSubscribed:this.isSubscribed,permission:Notification.permission,supported:this.supportsPush(),subscription:this.subscription}}async showBasicNotification(i,t={}){this.registration||(this.registration=await navigator.serviceWorker.ready);const e={body:"Ada cerita baru yang menunggu untuk dibaca!",icon:"/icons/icon-192x192.png",badge:"/icons/icon-72x72.png",tag:"basic-notification"};await this.registration.showNotification(i,{...e,...t})}async showDynamicNotification(i){this.registration||(this.registration=await navigator.serviceWorker.ready);const t={body:i.body||"Cerita baru tersedia",icon:i.icon||"/icons/icon-192x192.png",image:i.image||null,badge:"/icons/icon-72x72.png",tag:i.tag||`story-${Date.now()}`,data:{url:i.url||"/#/stories",storyId:i.storyId,action:"view"},actions:[{action:"view",title:"üìñ Baca Cerita"},{action:"dismiss",title:"‚ùå Tutup"}],vibrate:[100,50,100],requireInteraction:!0};await this.registration.showNotification(i.title||"ShareYourStory",t)}async showAdvancedNotification(i){this.registration||(this.registration=await navigator.serviceWorker.ready);const t=`Cerita Baru dari ${i.name}`,s={body:i.description?`${i.description.substring(0,100)}...`:"Cerita baru telah dipublikasikan",icon:"/icons/icon-192x192.png",badge:"/icons/icon-72x72.png",image:i.photoUrl||null,tag:`story-${i.id}`,data:{url:`/#/stories/${i.id}`,storyId:i.id,action:"view"},actions:[{action:"view",title:"üëÅÔ∏è Lihat Detail"},{action:"share",title:"üîó Bagikan"},{action:"dismiss",title:"‚ùå Tutup"}],vibrate:[200,100,200],requireInteraction:!0,timestamp:new Date(i.createdAt).getTime()};await this.registration.showNotification(t,s)}async testBasicNotification(){try{await this.showBasicNotification("Test Notifikasi Basic",{body:"Ini adalah notifikasi test level basic dari ShareYourStory",tag:"test-basic"}),console.log("Basic notification test successful")}catch(i){throw console.error("Basic notification test failed:",i),i}}async testSkilledNotification(){try{const i={title:"Test Notifikasi Dinamis",body:"Ini adalah notifikasi dengan konten dinamis dan actions",tag:"test-skilled",storyId:"test-123",url:"/#/stories"};await this.showDynamicNotification(i),console.log("Skilled notification test successful")}catch(i){throw console.error("Skilled notification test failed:",i),i}}async testAdvancedNotification(){try{const i={id:"test-advanced-123",name:"John Doe",description:"Ini adalah cerita test yang menunjukkan fitur notifikasi advanced dengan multiple actions dan navigasi ke detail cerita.",photoUrl:"/icons/icon-512x512.png",createdAt:new Date().toISOString()};await this.showAdvancedNotification(i),console.log("Advanced notification test successful")}catch(i){throw console.error("Advanced notification test failed:",i),i}}async simulateNewStory(){const i=[{id:"story-"+Date.now(),name:"Travel Blogger",description:"Pengalaman seru menjelajahi gunung tertinggi di Jawa Barat dengan pemandangan yang menakjubkan...",photoUrl:"/icons/icon-512x512.png",createdAt:new Date().toISOString()},{id:"story-"+(Date.now()+1),name:"Food Explorer",description:"Mencicipi makanan tradisional yang lezat dari berbagai daerah Indonesia...",photoUrl:"/icons/icon-512x512.png",createdAt:new Date().toISOString()}],t=i[Math.floor(Math.random()*i.length)];await this.showAdvancedNotification(t)}updateUI(){const i=document.getElementById("notification-toggle");i&&(i.checked=this.isSubscribed,i.disabled=!1),this.updateStatusDisplay()}updateStatusDisplay(){const i=document.getElementById("notification-status");i&&(this.supportsPush()?Notification.permission==="denied"?i.innerHTML='<span class="status inactive">‚ùå Izin ditolak</span>':this.isSubscribed?i.innerHTML='<span class="status active">üîî Notifikasi aktif</span>':i.innerHTML='<span class="status inactive">üîï Notifikasi nonaktif</span>':i.innerHTML='<span class="status inactive">‚ùå Browser tidak mendukung</span>')}setupEventListeners(){window.addEventListener("online",()=>{this.isSubscribed&&this.subscription&&this.syncSubscription()}),window.addEventListener("storage",i=>{i.key==="pushSubscription"&&this.checkSubscription()})}async syncSubscription(){if(this.isSubscribed&&this.subscription)try{await this.sendSubscriptionToServer(this.subscription),console.log("Push subscription synced with server")}catch(i){console.error("Failed to sync push subscription:",i)}}onSubscriptionChange(i){console.log("Subscription changed:",i);const t=new CustomEvent("pushSubscriptionChange",{detail:{isSubscribed:i,subscription:this.subscription}});window.dispatchEvent(t),this.updateUI()}urlBase64ToUint8Array(i){const t="=".repeat((4-i.length%4)%4),e=(i+t).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(e),n=new Uint8Array(s.length);for(let o=0;o<s.length;++o)n[o]=s.charCodeAt(o);return n}async debugStatus(){const i=await this.getSubscriptionState();return console.log("=== PUSH NOTIFICATION DEBUG INFO ==="),console.log("Supported:",i.supported),console.log("Permission:",i.permission),console.log("Subscribed:",i.isSubscribed),console.log("Subscription:",i.subscription),console.log("Service Worker:",this.registration),console.log("===================================="),i}async broadcastNewStory(i){try{console.log("Broadcasting new story notification:",i);const t={title:`üìñ Cerita Baru dari ${i.name}`,body:this.formatStoryDescription(i.description),image:i.photoUrl||"/icons/icon-512x512.png",tag:`broadcast-${i.id}`,data:{url:`/#/stories/${i.id}`,storyId:i.id,action:"view-detail"},actions:[{action:"view-detail",title:"üëÅÔ∏è Lihat Detail"},{action:"view-all",title:"üìö Semua Cerita"},{action:"dismiss",title:"‚ùå Tutup"}]};await this.showBroadcastNotification(t)}catch(t){throw console.error("Error broadcasting story:",t),t}}formatStoryDescription(i){return i?i.length>100?i.substring(0,100)+"...":i:"Cerita baru telah dibagikan"}async showBroadcastNotification(i){this.registration||(this.registration=await navigator.serviceWorker.ready);const t={body:i.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-72x72.png",image:i.image,tag:i.tag,data:i.data,actions:i.actions,vibrate:[200,100,200,100,200],requireInteraction:!0,timestamp:Date.now()};await this.registration.showNotification(i.title,t)}async simulateRealTimeNotification(){const i=[{id:"realtime-"+Date.now(),name:"Petualang Handal",description:"Baru saja menyelesaikan pendakian ke puncak gunung dengan pemandangan yang luar biasa indah! ‚òÄÔ∏èüèîÔ∏è",photoUrl:"/icons/icon-512x512.png",createdAt:new Date().toISOString()},{id:"realtime-"+(Date.now()+1),name:"Food Vlogger",description:"Mencoba resep tradisional keluarga yang diwariskan turun-temurun. Rasanya autentik dan penuh kenangan! üç≤‚ù§Ô∏è",photoUrl:"/icons/icon-512x512.png",createdAt:new Date().toISOString()},{id:"realtime-"+(Date.now()+2),name:"Travel Blogger",description:"Menemukan hidden gem di pedesaan dengan budaya lokal yang masih sangat terjaga. Pengalaman yang tak terlupakan! üåÑ‚ú®",photoUrl:"/icons/icon-512x512.png",createdAt:new Date().toISOString()}],t=i[Math.floor(Math.random()*i.length)];await this.broadcastNewStory(t)}}const u=new c;typeof window<"u"&&document.addEventListener("DOMContentLoaded",async()=>{console.log("Initializing push notification manager..."),await u.init()});export{u as p};
